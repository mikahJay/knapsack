name: CI / Build & Deploy

on:
  push:
    branches: [ deploy ]
  workflow_dispatch: {}

jobs:
  prepare:
    name: Prepare infra & repos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: latest

      - name: Ensure ECR repositories exist
        run: |
          for repo in need-server-test resource-server-test; do
            if ! aws ecr describe-repositories --repository-names "$repo" >/dev/null 2>&1; then
              aws ecr create-repository --repository-name "$repo"
            fi
          done

      - name: Terraform init & network apply
        run: |
          terraform -chdir=infra/terraform init -input=false -reconfigure || { echo "terraform init failed"; exit 1; }
          terraform -chdir=infra/terraform apply -var="environment=test" \
            -target=aws_vpc.knapsack \
            -target=aws_internet_gateway.igw \
            -target=aws_subnet.public \
            -target=aws_subnet.private \
            -target=aws_route_table.public \
            -target=aws_route_table_association.public \
            -target=aws_route_table.private \
            -target=aws_route_table_association.private \
            -target=aws_security_group.service_sg \
            -target=aws_security_group.nat_sg \
            -target=aws_instance.nat \
            -target=aws_lb.alb \
            -target=aws_lb_target_group.need_server_tg \
            -target=aws_lb_target_group.resource_server_tg \
            -target=aws_lb_listener.http \
            -target=aws_lb_listener_rule.resource_path \
            -auto-approve || echo "network apply exited non-zero"

  deploy:
    name: Build & Deploy services
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: need-server
            repo: need-server-test
            context: services/need-server
            tf_name: need_server
          - name: resource-server
            repo: resource-server-test
            context: services/resource-server
            tf_name: resource_server
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ matrix.repo }}:latest

      - name: Terraform init
        run: terraform -chdir=infra/terraform init -input=false -reconfigure

      - name: Import existing ECR repo into state (if present)
        run: |
          if aws ecr describe-repositories --repository-names "${{ matrix.repo }}" >/dev/null 2>&1; then
            terraform -chdir=infra/terraform state list aws_ecr_repository.${{ matrix.tf_name }} >/dev/null 2>&1 || terraform -chdir=infra/terraform import aws_ecr_repository.${{ matrix.tf_name }} ${{ matrix.repo }} || echo "terraform import ${matrix.repo} failed"
          fi

      - name: Ensure ECS cluster + service exist and redeploy
        run: |
          OUT=$(aws ecs update-service --cluster knapsack-test --service ${{ matrix.name }}-test --force-new-deployment 2>&1) || true
          if echo "$OUT" | grep -q "ServiceNotFoundException"; then
            echo "${{ matrix.name }} service not found; running Terraform to create service..."
            terraform -chdir=infra/terraform apply -var="environment=test" -target=aws_ecs_cluster.knapsack -target=aws_ecs_task_definition.${{ matrix.tf_name }} -target=aws_ecs_service.${{ matrix.tf_name }} -auto-approve || echo "terraform apply exited non-zero"
            echo "Retrying update-service..."
            aws ecs update-service --cluster knapsack-test --service ${{ matrix.name }}-test --force-new-deployment || echo "update-service failed after terraform"
          elif echo "$OUT" | grep -q "ClusterNotFoundException"; then
            echo "Cluster unexpectedly missing after create: $OUT"
          elif [ -n "$OUT" ]; then
            echo "update-service output: $OUT"
          else
            echo "${{ matrix.name }} redeploy triggered successfully."
          fi
